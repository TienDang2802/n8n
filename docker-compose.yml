# -----------------------------------------------------------------------------
# Shared configuration for all n8n containers
# -----------------------------------------------------------------------------
x-shared: &shared
  build:
    context: ./infrastructure/n8n
    args:
      N8N_VERSION: ${N8N_VERSION:-latest}
  restart: always
  # should run n8n in internal network, should not expose
  # If debug local, open "5678:5678"
  # ports:
  #   - "5678:5678"
  environment:
    # DB
    - DB_TYPE=postgresdb
    - DB_POSTGRESDB_HOST=db
    - DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
    - DB_POSTGRESDB_USER=${POSTGRES_USER}
    - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
    # --- Execution/Queue mode ---
    - EXECUTIONS_MODE=queue
    - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
    - QUEUE_HEALTH_CHECK_ACTIVE=true
    # --- Redis (Bull queue backend) ---
    - QUEUE_BULL_REDIS_HOST=redis
    - QUEUE_BULL_REDIS_PORT=${REDIS_PORT}
    - QUEUE_HEALTH_CHECK_ACTIVE=true
    # --- Security/Runtime ---
    - N8N_ENCRYPTION_KEY=${ENCRYPTION_KEY}
    - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
    - N8N_RESTRICT_FILE_ACCESS_TO=/home/node
    - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
    # --- Networking/Reverse Proxy ---
    - N8N_HOST=${N8N_HOST}
    - N8N_PROTOCOL=${N8N_PROTOCOL}
    - WEBHOOK_URL=${N8N_PROTOCOL}://${N8N_HOST}
    - TZ=Asia/Ho_Chi_Minh
    # Performance optimizations
    - N8N_METRICS=true
  links:
    - db
    - redis
  volumes:
    - ${DATA_PATH_HOST}/n8n/n8n_storage:/home/node/.n8n
    - ${DATA_PATH_HOST}/n8n/n8n-files:/home/node/.n8n-files
  depends_on:
    redis:
      condition: service_healthy
    db:
      condition: service_healthy

services:
  db:
    build:
      context: ./infrastructure/dbms/postgres
      args:
        POSTGRES_VERSION: ${POSTGRES_VERSION}
    container_name: n8n_postgres
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - TZ=Asia/Ho_Chi_Minh
    volumes:
      - ${DATA_PATH_HOST}/postgres:/var/lib/postgresql
    networks:
      - n8n_net
    healthcheck:
      test: [ 'CMD-SHELL', 'pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}' ]
      interval: 5s
      timeout: 5s
      retries: 10
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ### Redis ################################################
  redis:
    container_name: 'n8n_redis'
    build:
      context: ./infrastructure/dbms/redis
      args:
        REDIS_VERSION: ${REDIS_VERSION}
    volumes:
      - ${DATA_PATH_HOST}/redis:/data
    ports:
      - "${REDIS_PORT}:6379"
    healthcheck:
      test: [ 'CMD', 'redis-cli', 'ping' ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - n8n_net

  n8n:
    <<: *shared

  n8n-worker:
    <<: *shared
    command: worker
    depends_on:
      - n8n

  n8n-runners-main:
    image: n8nio/runners:${N8N_VERSION:-latest}
    restart: always
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n:5679
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
    depends_on:
      - n8n

  n8n-runners-worker:
    image: n8nio/runners:${N8N_VERSION:-latest}
    restart: always
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n-worker:5679
      - N8N_RUNNERS_AUTH_TOKEN=${N8N_RUNNERS_AUTH_TOKEN}
    depends_on:
      - n8n-worker

  nginx:
    build:
      context: ./infrastructure/nginx
    container_name: n8n_nginx
    environment:
      - NGINX_ENV=${NGINX_ENV:-prod}
      - NGINX_HOST=${NGINX_HOST}
      - NGINX_PORT=${NGINX_PORT:-443}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${NGINX_HOST_LOG_PATH}:/var/log/nginx
      - ${CERT_PATH}/nginx/letsencrypt:/etc/letsencrypt
      - ${CERT_PATH}/nginx/certbot:/var/www/certbot
      - ./infrastructure/nginx/99-autoreload.sh:/docker-entrypoint.d/99-autoreload.sh:ro
    depends_on:
      n8n:
        condition: service_started
    restart: always
    networks:
      - n8n_net
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    restart: unless-stopped
    volumes:
      - ${CERT_PATH}/nginx/letsencrypt:/etc/letsencrypt
      - ${CERT_PATH}/nginx/certbot:/var/www/certbot
    entrypoint: /bin/sh
    command:
      - -c
      - |
        trap exit TERM;
        while :; do
          echo "$(date): Checking certificate renewal..."
          if certbot renew --webroot -w /var/www/certbot --no-random-sleep-on-renew; then
            echo "$(date): Certificate renewal check completed"
          else
            echo "$(date): Certificate renewal check failed (this is normal if certificates are not due for renewal)"
          fi
          sleep 12h & wait $$!;
        done
    depends_on:
      - nginx
    networks:
      - n8n_net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

networks:
  n8n_net:
    driver: bridge
